{
    "repo": {
        "name": "demo-server",
        "source_default_branch": "develop"
    },
    "file_name": "auth.ts",
    "source": {
        "file_path": "routes/auth.ts",
        "commit_sha": "a1b2c3d4e5f6789012345678",
        "generated_at_iso": "2026-02-11T10:00:00.000Z",
        "language": "ts",
        "framework_tags": ["express", "node"],
        "link_to_github": "https://github.com/akeyless/demo-server/blob/a1b2c3d4e5f6789012345678/src/routes/auth.ts",
        "link_to_nx_kb": "/repos/demo-server/docs/routes/auth.ts.json"
    },
    "summary": {
        "purpose": "Handles user authentication routes including login, logout, and token refresh for the Express API server.",
        "problem_solved": "Provides secure JWT-based authentication endpoints that validate user credentials and manage session tokens."
    },
    "dependencies": {
        "external": [
            {
                "name": "express",
                "kind": "runtime",
                "why_used": "Web framework for defining route handlers and middleware"
            },
            {
                "name": "jsonwebtoken",
                "kind": "runtime",
                "why_used": "JWT token generation and verification for authentication"
            },
            {
                "name": "bcrypt",
                "kind": "runtime",
                "why_used": "Password hashing and comparison for secure credential storage"
            }
        ],
        "internal": [
            {
                "import_path": "../middleware/auth",
                "resolved_file_path": "middleware/auth.ts",
                "why_used": "Authentication middleware for protecting routes",
                "link_to_nx_kb": "/repos/demo-server/docs/middleware/auth.ts.json",
                "link_to_github": "https://github.com/akeyless/demo-server/blob/a1b2c3d4/src/middleware/auth.ts"
            },
            {
                "import_path": "../models/User",
                "resolved_file_path": "models/User.ts",
                "why_used": "User model for database queries",
                "link_to_nx_kb": "/repos/demo-server/docs/models/User.ts.json",
                "link_to_github": "https://github.com/akeyless/demo-server/blob/a1b2c3d4/src/models/User.ts"
            }
        ]
    },
    "exports": [
        {
            "name": "authRouter",
            "kind": "value",
            "description_one_line": "Express router with all authentication endpoints mounted",
            "symbol_id": "value_auth_router"
        },
        {
            "name": "loginHandler",
            "kind": "function",
            "description_one_line": "Handles POST /auth/login requests with email/password validation",
            "symbol_id": "function_login_handler"
        },
        {
            "name": "refreshTokenHandler",
            "kind": "function",
            "description_one_line": "Handles POST /auth/refresh to issue new JWT from refresh token",
            "symbol_id": "function_refresh_token_handler"
        }
    ],
    "symbols": [
        {
            "symbol_id": "value_auth_router",
            "name": "authRouter",
            "kind": "value",
            "description_one_line": "Express router with all authentication endpoints mounted",
            "details": {
                "what_it_does": "Creates and configures an Express Router instance with authentication-related routes. Mounts login, logout, and refresh endpoints with appropriate middleware."
            },
            "locations": {
                "source_line_start": 8,
                "source_line_end": 15,
                "github_permalink": "https://github.com/akeyless/demo-server/blob/a1b2c3d4/src/routes/auth.ts#L8-L15",
                "nx_kb_anchor": "value_auth_router"
            }
        },
        {
            "symbol_id": "function_login_handler",
            "name": "loginHandler",
            "kind": "function",
            "description_one_line": "Handles POST /auth/login requests with email/password validation",
            "signature": {
                "params": [
                    {
                        "name": "req",
                        "type": "Request",
                        "required": true,
                        "description": "Express request object with body containing email and password"
                    },
                    {
                        "name": "res",
                        "type": "Response",
                        "required": true,
                        "description": "Express response object"
                    }
                ],
                "returns": {
                    "type": "Promise<void>",
                    "description": "Sends JSON response with JWT access token and refresh token on success, or 401 on failure"
                }
            },
            "details": {
                "what_it_does": "Validates user credentials by looking up the email in the database and comparing the hashed password. On success, generates a JWT access token (15min expiry) and a refresh token (7d expiry). Sets the refresh token as an httpOnly cookie.",
                "side_effects": [
                    "Writes refresh token to database",
                    "Sets httpOnly cookie on response"
                ],
                "error_cases": [
                    {
                        "condition": "Email not found in database",
                        "behavior": "Returns 401 with message 'Invalid credentials'"
                    },
                    {
                        "condition": "Password does not match hash",
                        "behavior": "Returns 401 with message 'Invalid credentials'"
                    },
                    {
                        "condition": "Database connection error",
                        "behavior": "Returns 500 with message 'Internal server error'"
                    }
                ]
            },
            "examples": {
                "minimal_correct": {
                    "title": "Basic login request",
                    "code": "const response = await fetch('/auth/login', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({ email: 'user@example.com', password: 'secret123' })\n});\nconst { accessToken } = await response.json();"
                },
                "extensive_correct": {
                    "title": "Login with error handling and token storage",
                    "code": "try {\n  const response = await fetch('/auth/login', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    credentials: 'include', // Important for receiving cookies\n    body: JSON.stringify({ email, password })\n  });\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.message);\n  }\n\n  const { accessToken, expiresIn } = await response.json();\n  localStorage.setItem('accessToken', accessToken);\n  \n  // Schedule token refresh before expiry\n  setTimeout(refreshToken, (expiresIn - 60) * 1000);\n} catch (error) {\n  console.error('Login failed:', error.message);\n}"
                },
                "incorrect": {
                    "title": "Missing credentials header",
                    "code": "// Missing 'credentials: include' means refresh token cookie won't be set\nconst response = await fetch('/auth/login', {\n  method: 'POST',\n  body: JSON.stringify({ email, password })\n});",
                    "why_incorrect": "Missing Content-Type header and credentials: 'include'. Without credentials, the httpOnly cookie for the refresh token will not be saved by the browser."
                }
            },
            "locations": {
                "source_line_start": 17,
                "source_line_end": 52,
                "github_permalink": "https://github.com/akeyless/demo-server/blob/a1b2c3d4/src/routes/auth.ts#L17-L52",
                "nx_kb_anchor": "function_login_handler"
            }
        },
        {
            "symbol_id": "function_refresh_token_handler",
            "name": "refreshTokenHandler",
            "kind": "function",
            "description_one_line": "Handles POST /auth/refresh to issue new JWT from refresh token",
            "signature": {
                "params": [
                    {
                        "name": "req",
                        "type": "Request",
                        "required": true,
                        "description": "Express request with refresh token in httpOnly cookie"
                    },
                    {
                        "name": "res",
                        "type": "Response",
                        "required": true,
                        "description": "Express response object"
                    }
                ],
                "returns": {
                    "type": "Promise<void>",
                    "description": "Sends JSON response with new access token, or 401 if refresh token is invalid/expired"
                }
            },
            "details": {
                "what_it_does": "Reads the refresh token from the httpOnly cookie, validates it against the database, and issues a new access token. If the refresh token is expired or revoked, returns 401.",
                "error_cases": [
                    {
                        "condition": "No refresh token cookie present",
                        "behavior": "Returns 401 with message 'No refresh token'"
                    },
                    {
                        "condition": "Refresh token expired or revoked",
                        "behavior": "Returns 401 with message 'Invalid refresh token'"
                    }
                ]
            },
            "examples": {
                "minimal_correct": {
                    "title": "Refresh access token",
                    "code": "const response = await fetch('/auth/refresh', {\n  method: 'POST',\n  credentials: 'include'\n});\nconst { accessToken } = await response.json();"
                }
            },
            "locations": {
                "source_line_start": 54,
                "source_line_end": 78,
                "github_permalink": "https://github.com/akeyless/demo-server/blob/a1b2c3d4/src/routes/auth.ts#L54-L78",
                "nx_kb_anchor": "function_refresh_token_handler"
            }
        }
    ],
    "swagger": {
        "covered_endpoints": [
            {
                "method": "POST",
                "path": "/auth/login",
                "operation_id": "loginUser",
                "confidence": "high"
            },
            {
                "method": "POST",
                "path": "/auth/logout",
                "operation_id": "logoutUser",
                "confidence": "high"
            },
            {
                "method": "POST",
                "path": "/auth/refresh",
                "operation_id": "refreshToken",
                "confidence": "high"
            }
        ]
    },
    "quality": {
        "generation_confidence": "high",
        "known_gaps": []
    }
}
