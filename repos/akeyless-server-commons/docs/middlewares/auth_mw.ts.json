{
    "repo": {
        "name": "akeyless-server-commons",
        "source_default_branch": "main"
    },
    "file_name": "auth_mw.ts",
    "source": {
        "file_path": "middlewares/auth_mw.ts",
        "commit_sha": "720e8b90aaf64dfc60e48e6c68287688bd79409a",
        "generated_at_iso": "2026-02-12T00:00:00.000Z",
        "language": "ts",
        "framework_tags": ["node", "express"],
        "link_to_github": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/middlewares/auth_mw.ts",
        "link_to_nx_kb": "/repos/akeyless-server-commons/docs/middlewares/auth_mw.ts.json"
    },
    "summary": {
        "purpose": "Provides Express authentication middleware for verifying Firebase user tokens, NX platform user logins, and API client token authentication.",
        "problem_solved": "Centralizes authentication logic into reusable middleware functions so that route handlers do not need to implement their own token verification, user lookup, or client validation."
    },
    "dependencies": {
        "external": [
            {
                "package": "akeyless-types-commons",
                "imports": ["NxUser", "Client"],
                "purpose": "Type definitions for NX platform user and client entities"
            }
        ],
        "internal": [
            {
                "module": "../helpers",
                "resolved_path": "helpers/index.ts",
                "imports": ["verify_token", "json_failed", "query_document_optional", "get_user_by_identifier"],
                "link_to_nx_kb": "/repos/akeyless-server-commons/docs/helpers/index.ts.json",
                "link_to_github": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/helpers/index.ts",
                "purpose": "Firebase token verification, Firestore document querying, user lookup by identifier, and JSON failure response formatting"
            },
            {
                "module": "../managers",
                "resolved_path": "managers/index.ts",
                "imports": ["logger"],
                "link_to_nx_kb": "/repos/akeyless-server-commons/docs/managers/index.ts.json",
                "link_to_github": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/managers/index.ts",
                "purpose": "Logger singleton for error logging"
            },
            {
                "module": "../types",
                "resolved_path": "types/index.ts",
                "imports": ["MW"],
                "link_to_nx_kb": "/repos/akeyless-server-commons/docs/types/index.ts.json",
                "link_to_github": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/types/index.ts",
                "purpose": "Middleware type alias"
            }
        ]
    },
    "exports": [
        {
            "name": "verify_user_auth",
            "kind": "variable",
            "description": "Async Express middleware that verifies a Firebase authorization token and attaches decoded user to req.body.firebase_user"
        },
        {
            "name": "nx_user_login",
            "kind": "variable",
            "description": "Async Express middleware that verifies a Firebase token, looks up the NX platform user, and attaches it to req.body.user"
        },
        {
            "name": "client_login",
            "kind": "variable",
            "description": "Async Express middleware that validates an API token against the nx-clients Firestore collection and attaches the client data to req.body.client"
        }
    ],
    "symbols": [
        {
            "symbol_id": "variable_verify_user_auth",
            "name": "verify_user_auth",
            "kind": "variable",
            "description_one_line": "Async middleware that verifies a Firebase ID token from the Authorization header and attaches the decoded user to the request body.",
            "signature": {
                "params": [
                    {
                        "name": "req",
                        "type": "Request",
                        "description": "Express request; reads req.headers.authorization for the Firebase token"
                    },
                    {
                        "name": "res",
                        "type": "Response",
                        "description": "Express response; used to send 403 on auth failure"
                    },
                    {
                        "name": "next",
                        "type": "NextFunction",
                        "description": "Express next function; called on successful verification"
                    }
                ],
                "returns": {
                    "type": "void",
                    "description": "Calls next() on success or sends 403 with json_failed error on failure"
                }
            },
            "details": {
                "what_it_does": "Extracts the authorization token from req.headers.authorization, passes it to verify_token to validate the Firebase ID token, and on success attaches the decoded user data to req.body.firebase_user before calling next(). On failure, logs the error via logger.error and responds with HTTP 403 and a json_failed error payload.",
                "side_effects": [
                    "Mutates req.body by adding firebase_user property on success",
                    "Logs authentication errors via logger.error",
                    "Sends HTTP 403 response on authentication failure"
                ],
                "error_cases": [
                    "Returns 403 with json_failed error if the authorization token is missing, invalid, or expired"
                ]
            },
            "examples": {
                "minimal_correct": "app.get('/protected', verify_user_auth, (req, res) => { res.json(req.body.firebase_user); });"
            },
            "locations": {
                "source_line_start": 6,
                "source_line_end": 15,
                "github_permalink": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/middlewares/auth_mw.ts#L6-L15",
                "nx_kb_anchor": "#variable_verify_user_auth"
            }
        },
        {
            "symbol_id": "variable_nx_user_login",
            "name": "nx_user_login",
            "kind": "variable",
            "description_one_line": "Async middleware that verifies a Firebase token, looks up the corresponding NX user by phone or email, and attaches the user to the request.",
            "signature": {
                "params": [
                    {
                        "name": "req",
                        "type": "Request",
                        "description": "Express request; reads req.headers.authorization for the Firebase token"
                    },
                    {
                        "name": "res",
                        "type": "Response",
                        "description": "Express response; used to send 403 on failure"
                    },
                    {
                        "name": "next",
                        "type": "NextFunction",
                        "description": "Express next function; called on successful login"
                    }
                ],
                "returns": {
                    "type": "void",
                    "description": "Calls next() on success or sends 403 with json_failed error on failure"
                }
            },
            "details": {
                "what_it_does": "Verifies the Firebase authorization token from the request header, extracts phone_number and email from the decoded token, looks up the NX user via get_user_by_identifier using phone_number (preferred) or email, constructs a full_name from first_name and last_name, and attaches the enriched NxUser object to req.body.user. If no phone_number or email is found in the token, or if no NX user matches, throws an error resulting in a 403 response.",
                "side_effects": [
                    "Mutates req.body by adding user property (typed as NxUser with full_name) on success",
                    "Sends HTTP 403 response on authentication or user lookup failure"
                ],
                "error_cases": [
                    "Returns 403 if authorization token is invalid or missing",
                    "Returns 403 with 'Invalid authorization token' if decoded token has neither phone_number nor email",
                    "Returns 403 with 'No user found with phone number: {phone} or email: {email}' if no NX user matches"
                ]
            },
            "examples": {
                "minimal_correct": "app.get('/nx/profile', nx_user_login, (req, res) => { res.json(req.body.user); });"
            },
            "locations": {
                "source_line_start": 17,
                "source_line_end": 35,
                "github_permalink": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/middlewares/auth_mw.ts#L17-L35",
                "nx_kb_anchor": "#variable_nx_user_login"
            }
        },
        {
            "symbol_id": "variable_client_login",
            "name": "client_login",
            "kind": "variable",
            "description_one_line": "Async middleware that validates an API token against the nx-clients Firestore collection and attaches the client data to the request.",
            "signature": {
                "params": [
                    {
                        "name": "req",
                        "type": "Request",
                        "description": "Express request; reads req.headers.authorization for the API token"
                    },
                    {
                        "name": "res",
                        "type": "Response",
                        "description": "Express response; used to send 403 on failure"
                    },
                    {
                        "name": "next",
                        "type": "NextFunction",
                        "description": "Express next function; called on successful client authentication"
                    }
                ],
                "returns": {
                    "type": "void",
                    "description": "Calls next() on success or sends 403 with json_failed error on failure"
                }
            },
            "details": {
                "what_it_does": "Reads the authorization token from the request headers, queries the 'nx-clients' Firestore collection for a document where api_token matches the provided token using query_document_optional, and on success attaches the Client data to req.body.client. Throws an error if no token is provided or if no matching client is found.",
                "side_effects": [
                    "Mutates req.body by adding client property (typed as Client) on success",
                    "Queries the 'nx-clients' Firestore collection",
                    "Sends HTTP 403 response on authentication failure"
                ],
                "error_cases": [
                    "Returns 403 with 'Authorization token not found.' if req.headers.authorization is falsy",
                    "Returns 403 with 'No client found with token: {token}.' if no matching client exists in Firestore"
                ]
            },
            "examples": {
                "minimal_correct": "app.get('/api/data', client_login, (req, res) => { res.json(req.body.client); });"
            },
            "locations": {
                "source_line_start": 37,
                "source_line_end": 52,
                "github_permalink": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/middlewares/auth_mw.ts#L37-L52",
                "nx_kb_anchor": "#variable_client_login"
            }
        }
    ],
    "quality": {
        "generation_confidence": "high",
        "known_gaps": []
    }
}
