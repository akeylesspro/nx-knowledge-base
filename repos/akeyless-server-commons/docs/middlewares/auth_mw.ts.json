{
  "repo": {
    "name": "akeyless-server-commons",
    "source_default_branch": "main"
  },
  "file_name": "auth_mw.ts",
  "source": {
    "file_path": "middlewares/auth_mw.ts",
    "commit_sha": "fdd501a3d2595ba30c43f5272500f5ccdefa5308",
    "generated_at_iso": "2026-02-18T08:11:51.000Z",
    "language": "ts",
    "framework_tags": ["node", "express"],
    "link_to_github": "https://github.com/akeyless/akeyless-server-commons/blob/fdd501a3d2595ba30c43f5272500f5ccdefa5308/src/middlewares/auth_mw.ts",
    "link_to_nx_kb": "/repos/akeyless-server-commons/docs/middlewares/auth_mw.ts"
  },
  "summary": {
    "purpose": "Provides Express authentication middleware for verifying Firebase Auth tokens and resolving user identities (NxUser or Client) from Firestore.",
    "problem_solved": "Centralises authentication logic for three distinct auth flows: generic Firebase token verification, NxUser login (by phone/email), and API client authentication (by API token)."
  },
  "dependencies": {
    "external": [
      {
        "name": "akeyless-types-commons",
        "kind": "runtime",
        "why_used": "Provides NxUser and Client type definitions."
      }
    ],
    "internal": [
      {
        "import_path": "../helpers",
        "resolved_file_path": "helpers/index.ts",
        "why_used": "Imports verify_token, json_failed, query_document_optional, and get_user_by_identifier.",
        "link_to_nx_kb": "/repos/akeyless-server-commons/docs/helpers/index.ts",
        "link_to_github": "https://github.com/akeyless/akeyless-server-commons/blob/fdd501a3d2595ba30c43f5272500f5ccdefa5308/src/helpers/index.ts"
      },
      {
        "import_path": "../managers",
        "resolved_file_path": "managers/index.ts",
        "why_used": "Imports the logger singleton.",
        "link_to_nx_kb": "/repos/akeyless-server-commons/docs/managers/index.ts",
        "link_to_github": "https://github.com/akeyless/akeyless-server-commons/blob/fdd501a3d2595ba30c43f5272500f5ccdefa5308/src/managers/index.ts"
      },
      {
        "import_path": "../types",
        "resolved_file_path": "types/index.ts",
        "why_used": "Imports the MW type for Express middleware signature.",
        "link_to_nx_kb": "/repos/akeyless-server-commons/docs/types/index.ts",
        "link_to_github": "https://github.com/akeyless/akeyless-server-commons/blob/fdd501a3d2595ba30c43f5272500f5ccdefa5308/src/types/index.ts"
      }
    ]
  },
  "exports": [
    {
      "name": "verify_user_auth",
      "kind": "function",
      "description_one_line": "Middleware that verifies a Firebase Auth token and attaches the decoded user to req.body.firebase_user.",
      "symbol_id": "verify_user_auth"
    },
    {
      "name": "nx_user_login",
      "kind": "function",
      "description_one_line": "Middleware that verifies a Firebase token, looks up the NxUser, and attaches it to req.body.user.",
      "symbol_id": "nx_user_login"
    },
    {
      "name": "client_login",
      "kind": "function",
      "description_one_line": "Middleware that authenticates an API client by token from the Authorization header.",
      "symbol_id": "client_login"
    }
  ],
  "symbols": [
    {
      "symbol_id": "verify_user_auth",
      "name": "verify_user_auth",
      "kind": "function",
      "description_one_line": "Middleware that verifies a Firebase Auth token and attaches the decoded user to req.body.firebase_user.",
      "signature": {
        "params": [
          {"name": "req", "type": "Request", "required": true, "description": "Express request. Reads req.headers.authorization."},
          {"name": "res", "type": "Response", "required": true, "description": "Express response."},
          {"name": "next", "type": "NextFunction", "required": true, "description": "Express next function."}
        ],
        "returns": {"type": "void", "description": "Calls next() on success or sends 403 on failure."}
      },
      "details": {
        "what_it_does": "Calls verify_token with the Authorization header. On success, attaches the decoded token to req.body.firebase_user and calls next(). On failure, logs the error and sends a 403 response with json_failed.",
        "error_cases": [{"condition": "Token is invalid or missing", "behavior": "Sends HTTP 403 with json_failed(error)."}]
      },
      "examples": {
        "minimal_correct": {"title": "Use as route middleware", "code": "app.get('/protected', verify_user_auth, (req, res) => {\n  const user = req.body.firebase_user;\n  res.json(json_ok(user));\n});"}
      },
      "locations": {"source_line_start": 6, "source_line_end": 15, "github_permalink": "https://github.com/akeyless/akeyless-server-commons/blob/fdd501a3d2595ba30c43f5272500f5ccdefa5308/src/middlewares/auth_mw.ts#L6", "nx_kb_anchor": "verify_user_auth"}
    },
    {
      "symbol_id": "nx_user_login",
      "name": "nx_user_login",
      "kind": "function",
      "description_one_line": "Middleware that verifies a Firebase token, looks up the NxUser, and attaches it to req.body.user.",
      "signature": {
        "params": [
          {"name": "req", "type": "Request", "required": true, "description": "Express request. Reads req.headers.authorization."},
          {"name": "res", "type": "Response", "required": true, "description": "Express response."},
          {"name": "next", "type": "NextFunction", "required": true, "description": "Express next function."}
        ],
        "returns": {"type": "void", "description": "Calls next() on success or sends 403 on failure."}
      },
      "details": {
        "what_it_does": "Verifies the Firebase token, extracts phone_number and email from the decoded token, looks up the NxUser in Firestore via get_user_by_identifier, constructs a full_name field, and attaches the enriched user to req.body.user.",
        "error_cases": [
          {"condition": "Token has neither phone_number nor email", "behavior": "Throws 'Invalid authorization token', sends 403."},
          {"condition": "No NxUser found for the identifier", "behavior": "Throws 'No user found with phone number: ... or email: ...', sends 403."}
        ]
      },
      "examples": {
        "minimal_correct": {"title": "Use for NxUser-authenticated routes", "code": "app.post('/api/action', nx_user_login, (req, res) => {\n  const user: NxUser = req.body.user;\n  res.json(json_ok({ user_id: user.id }));\n});"}
      },
      "locations": {"source_line_start": 17, "source_line_end": 35, "github_permalink": "https://github.com/akeyless/akeyless-server-commons/blob/fdd501a3d2595ba30c43f5272500f5ccdefa5308/src/middlewares/auth_mw.ts#L17", "nx_kb_anchor": "nx_user_login"}
    },
    {
      "symbol_id": "client_login",
      "name": "client_login",
      "kind": "function",
      "description_one_line": "Middleware that authenticates an API client by token from the Authorization header.",
      "signature": {
        "params": [
          {"name": "req", "type": "Request", "required": true, "description": "Express request. Reads req.headers.authorization as the API token."},
          {"name": "res", "type": "Response", "required": true, "description": "Express response."},
          {"name": "next", "type": "NextFunction", "required": true, "description": "Express next function."}
        ],
        "returns": {"type": "void", "description": "Calls next() on success or sends 403 on failure."}
      },
      "details": {
        "what_it_does": "Reads the Authorization header as a raw API token, queries the 'nx-clients' Firestore collection for a document where api_token matches, and attaches the Client document to req.body.client.",
        "error_cases": [
          {"condition": "Authorization header is missing", "behavior": "Throws Error('Authorization token not found.'), sends 403."},
          {"condition": "No client found with the token", "behavior": "Throws Error('No client found with token: ...'), sends 403."}
        ]
      },
      "examples": {
        "minimal_correct": {"title": "Use for API client authentication", "code": "app.post('/api/data', client_login, (req, res) => {\n  const client: Client = req.body.client;\n  res.json(json_ok({ client_id: client.id }));\n});"}
      },
      "locations": {"source_line_start": 37, "source_line_end": 52, "github_permalink": "https://github.com/akeyless/akeyless-server-commons/blob/fdd501a3d2595ba30c43f5272500f5ccdefa5308/src/middlewares/auth_mw.ts#L37", "nx_kb_anchor": "client_login"}
    }
  ],
  "quality": {
    "generation_confidence": "high",
    "known_gaps": []
  }
}
