{
    "repo": {
        "name": "akeyless-server-commons",
        "source_default_branch": "main"
    },
    "file_name": "email_helpers.ts",
    "source": {
        "file_path": "helpers/email_helpers.ts",
        "commit_sha": "720e8b90aaf64dfc60e48e6c68287688bd79409a",
        "generated_at_iso": "2026-02-12T00:00:00.000Z",
        "language": "ts",
        "framework_tags": [
            "node"
        ],
        "link_to_github": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/helpers/email_helpers.ts",
        "link_to_nx_kb": "/repos/akeyless-server-commons/docs/helpers/email_helpers.ts.json"
    },
    "summary": {
        "purpose": "Provides email-sending utilities via SendGrid, including attachment creation from files, buffers, and URLs, plus a high-level send_email function that resolves recipient groups and records audit entries.",
        "problem_solved": "Abstracts away SendGrid API integration, email group resolution from Firestore settings, CC merging, MIME type detection, attachment encoding, and audit logging into reusable helper functions."
    },
    "dependencies": {
        "external": [
            {
                "name": "@sendgrid/mail",
                "reason": "SendGrid client used to send transactional emails"
            },
            {
                "name": "fs",
                "reason": "Node.js filesystem module for reading file contents when creating attachments"
            },
            {
                "name": "path",
                "reason": "Node.js path module for extracting file extensions and basenames"
            }
        ],
        "internal": [
            {
                "name": "helpers/index (add_audit_record, get_document_by_id, ignore_ssl_request)",
                "link_to_nx_kb": "/repos/akeyless-server-commons/docs/helpers/index.ts.json",
                "link_to_github": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/helpers/index.ts"
            },
            {
                "name": "types (EmailSettings, EmailData, EmailAttachment)",
                "link_to_nx_kb": "/repos/akeyless-server-commons/docs/types/index.ts.json",
                "link_to_github": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/types/index.ts"
            },
            {
                "name": "managers (logger)",
                "link_to_nx_kb": "/repos/akeyless-server-commons/docs/managers/index.ts.json",
                "link_to_github": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/managers/index.ts"
            }
        ]
    },
    "exports": [
        "create_attachment_from_file",
        "create_attachment_from_buffer",
        "create_attachment_from_url",
        "send_email"
    ],
    "symbols": [
        {
            "symbol_id": "function_create_attachment_from_file",
            "name": "create_attachment_from_file",
            "kind": "function",
            "description_one_line": "Creates an EmailAttachment from a local file by reading it, base64-encoding its content, and detecting the MIME type.",
            "signature": {
                "params": [
                    {
                        "name": "file_path",
                        "type": "string",
                        "required": true,
                        "description": "Absolute or relative path to the file on disk."
                    },
                    {
                        "name": "filename",
                        "type": "string",
                        "required": false,
                        "description": "Override filename for the attachment; defaults to the basename of file_path."
                    },
                    {
                        "name": "disposition",
                        "type": "\"attachment\" | \"inline\"",
                        "required": false,
                        "description": "Content disposition of the attachment. Defaults to 'attachment'."
                    }
                ],
                "returns": {
                    "type": "Promise<EmailAttachment>",
                    "description": "A promise resolving to an EmailAttachment object with base64 content, filename, MIME type, and disposition."
                }
            },
            "details": {
                "what_it_does": "Reads the file at file_path synchronously using fs.readFileSync, converts its content to base64, infers the MIME type from the file extension via the internal get_mime_type helper, and returns an EmailAttachment object ready for SendGrid.",
                "side_effects": [
                    "Reads a file from the local filesystem."
                ],
                "error_cases": [
                    "If the file cannot be read (e.g. does not exist or permission denied), the error is logged via logger.error and re-thrown."
                ]
            },
            "examples": {
                "minimal_correct": "const attachment = await create_attachment_from_file('/tmp/report.pdf');"
            },
            "locations": {
                "source_line_start": 8,
                "source_line_end": 28,
                "github_permalink": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/helpers/email_helpers.ts#L8-L28",
                "nx_kb_anchor": "#function_create_attachment_from_file"
            }
        },
        {
            "symbol_id": "function_create_attachment_from_buffer",
            "name": "create_attachment_from_buffer",
            "kind": "function",
            "description_one_line": "Creates an EmailAttachment from a Buffer or Uint8Array by base64-encoding it.",
            "signature": {
                "params": [
                    {
                        "name": "buffer",
                        "type": "Buffer | Uint8Array",
                        "required": true,
                        "description": "The raw binary data to attach."
                    },
                    {
                        "name": "filename",
                        "type": "string",
                        "required": true,
                        "description": "The filename to assign to the attachment."
                    },
                    {
                        "name": "mime_type",
                        "type": "string",
                        "required": true,
                        "description": "The MIME type of the attachment (e.g. 'application/pdf')."
                    },
                    {
                        "name": "disposition",
                        "type": "\"attachment\" | \"inline\"",
                        "required": false,
                        "description": "Content disposition of the attachment. Defaults to 'attachment'."
                    }
                ],
                "returns": {
                    "type": "EmailAttachment",
                    "description": "An EmailAttachment object with base64-encoded content."
                }
            },
            "details": {
                "what_it_does": "Converts the provided Buffer or Uint8Array to a Node.js Buffer (if not already one), base64-encodes it, and returns a fully-formed EmailAttachment object."
            },
            "examples": {
                "minimal_correct": "const attachment = create_attachment_from_buffer(myBuffer, 'file.pdf', 'application/pdf');"
            },
            "locations": {
                "source_line_start": 30,
                "source_line_end": 43,
                "github_permalink": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/helpers/email_helpers.ts#L30-L43",
                "nx_kb_anchor": "#function_create_attachment_from_buffer"
            }
        },
        {
            "symbol_id": "function_create_attachment_from_url",
            "name": "create_attachment_from_url",
            "kind": "function",
            "description_one_line": "Downloads a file from a URL (SSL-ignoring) and returns it as a base64-encoded email attachment.",
            "signature": {
                "params": [
                    {
                        "name": "url",
                        "type": "string",
                        "required": true,
                        "description": "The URL to download the file from."
                    },
                    {
                        "name": "filename",
                        "type": "string",
                        "required": true,
                        "description": "The filename for the resulting attachment."
                    }
                ],
                "returns": {
                    "type": "Promise<{ content: string; filename: string; type: string; disposition: string }>",
                    "description": "A promise resolving to an attachment-like object with base64 content, filename, content type from the response header, and 'attachment' disposition."
                }
            },
            "details": {
                "what_it_does": "Uses ignore_ssl_request to perform an HTTP GET request to the given URL with a 20-second timeout and arraybuffer response type. Converts the response data to a base64 string and infers content type from the response headers, defaulting to 'application/pdf'.",
                "side_effects": [
                    "Makes an outbound HTTP request to the provided URL."
                ],
                "error_cases": [
                    "If the HTTP request fails, the error is logged via logger.error and re-thrown."
                ]
            },
            "examples": {
                "minimal_correct": "const attachment = await create_attachment_from_url('https://example.com/file.pdf', 'report.pdf');"
            },
            "locations": {
                "source_line_start": 45,
                "source_line_end": 67,
                "github_permalink": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/helpers/email_helpers.ts#L45-L67",
                "nx_kb_anchor": "#function_create_attachment_from_url"
            }
        },
        {
            "symbol_id": "function_get_mime_type",
            "name": "get_mime_type",
            "kind": "function",
            "description_one_line": "Maps a file extension to its MIME type string using a built-in lookup table.",
            "signature": {
                "params": [
                    {
                        "name": "file_path",
                        "type": "string",
                        "required": true,
                        "description": "File path from which to extract the extension."
                    }
                ],
                "returns": {
                    "type": "string",
                    "description": "The MIME type string, or 'application/octet-stream' if the extension is not recognized."
                }
            },
            "details": {
                "what_it_does": "Extracts the lowercase file extension from the given path, looks it up in a hardcoded Record of common MIME types (pdf, doc, docx, xls, xlsx, ppt, pptx, txt, csv, json, xml, zip, rar, 7z, jpg, jpeg, png, gif, bmp, svg, mp3, mp4, avi, mov), and returns the corresponding MIME type or 'application/octet-stream' as a fallback."
            },
            "locations": {
                "source_line_start": 69,
                "source_line_end": 99,
                "github_permalink": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/helpers/email_helpers.ts#L69-L99",
                "nx_kb_anchor": "#function_get_mime_type"
            }
        },
        {
            "symbol_id": "function_send_email",
            "name": "send_email",
            "kind": "function",
            "description_one_line": "Sends an email via SendGrid, resolving recipient groups from Firestore settings, merging CC lists, and recording an audit entry.",
            "signature": {
                "params": [
                    {
                        "name": "email_data",
                        "type": "EmailData",
                        "required": true,
                        "description": "Object containing to, cc, from, group_name, subject, body_html or body_plain_text, entity_for_audit, and optional attachments."
                    },
                    {
                        "name": "options",
                        "type": "{ debug?: boolean }",
                        "required": false,
                        "description": "Optional configuration; when debug is true, logs the email payload on both success and failure."
                    }
                ],
                "returns": {
                    "type": "Promise<void>",
                    "description": "Resolves when the email has been sent and the audit record has been created, or logs the error on failure."
                }
            },
            "details": {
                "what_it_does": "Fetches email settings (API key, groups, default from/cc) from the 'nx-settings' Firestore document. Validates that either 'to' or 'group_name' is provided and that either body_html or body_plain_text exists. Resolves group recipients by merging group 'to' and 'cc' addresses with any explicitly provided values. Configures the SendGrid API key, builds a MailDataRequired message, sends it via sendgrid.send(), validates a 202 status code, and records an audit entry via add_audit_record. Errors are caught, logged, but not re-thrown.",
                "side_effects": [
                    "Sends an email via the SendGrid API.",
                    "Writes an audit record to Firestore via add_audit_record.",
                    "Sets the SendGrid API key globally via sendgrid.setApiKey."
                ],
                "error_cases": [
                    "Throws (but catches internally) if no 'to' or 'group_name' is supplied.",
                    "Throws (but catches internally) if no body_html or body_plain_text is supplied.",
                    "Throws (but catches internally) if the group_name is not found in settings.",
                    "Throws (but catches internally) if the SendGrid response status code is not 202."
                ]
            },
            "examples": {
                "minimal_correct": "await send_email({ to: 'user@example.com', subject: 'Hello', body_html: '<p>Hi</p>', entity_for_audit: 'my_service' });"
            },
            "locations": {
                "source_line_start": 101,
                "source_line_end": 169,
                "github_permalink": "https://github.com/akeylesspro/akeyless-server-commons/blob/720e8b90aaf64dfc60e48e6c68287688bd79409a/src/helpers/email_helpers.ts#L101-L169",
                "nx_kb_anchor": "#function_send_email"
            }
        }
    ],
    "quality": {
        "generation_confidence": "high",
        "known_gaps": []
    }
}