# =========================================================
# NX-KNOWLEDGE-BASE â€” Receive Sync Dispatch
# Triggered by repository_dispatch from documented repos
# =========================================================

name: Receive Sync Dispatch

on:
  repository_dispatch:
    types: [sync-docs]

permissions:
  contents: write
  pull-requests: write

# Issue #15: Prevent concurrent syncs for the same source repo
concurrency:
  group: sync-${{ github.event.client_payload.repo }}
  cancel-in-progress: false

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout NX-KNOWLEDGE-BASE
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Log Dispatch Payload
        run: |
          echo "Repo: ${{ github.event.client_payload.repo }}"
          echo "Branch: ${{ github.event.client_payload.branch }}"
          echo "Commit: ${{ github.event.client_payload.commit_sha }}"
          echo "Files changed: ${{ github.event.client_payload.file_count }}"

      - name: Skip if no files changed
        id: pre-check
        run: |
          COUNT="${{ github.event.client_payload.file_count }}"
          COUNT="${COUNT:-0}"
          if ! [[ "$COUNT" =~ ^[0-9]+$ ]] || [ "$COUNT" -eq "0" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No files changed in src/ (file_count=$COUNT). Skipping sync."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout source repository
        if: steps.pre-check.outputs.skip == 'false'
        uses: actions/checkout@v4
        with:
          # Must exist as a secret in THIS repo (nx-knowledge-base) and have read access to source repos
          token: ${{ secrets.NX_KB_DISPATCH_TOKEN }}
          repository: akeylesspro/${{ github.event.client_payload.repo }}
          ref: ${{ github.event.client_payload.commit_sha }}
          path: _source/${{ github.event.client_payload.repo }}

      - name: Install Claude CLI
        if: steps.pre-check.outputs.skip == 'false'
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Git
        if: steps.pre-check.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create sync branch
        if: steps.pre-check.outputs.skip == 'false'
        id: branch
        run: |
          SHORT_SHA=$(echo "${{ github.event.client_payload.commit_sha }}" | cut -c1-7)
          TS=$(date -u +%Y%m%d%H%M%S)
          SYNC_BRANCH="sync/${{ github.event.client_payload.repo }}-${SHORT_SHA}-${TS}"
          git checkout -b "$SYNC_BRANCH"

          BASE_SHA=$(git rev-parse HEAD)

          echo "name=$SYNC_BRANCH" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT

      - name: Write dispatch payload to file
        if: steps.pre-check.outputs.skip == 'false'
        env:
          PAYLOAD: ${{ toJson(github.event.client_payload) }}
        run: echo "$PAYLOAD" > /tmp/sync-payload.json

      - name: Invoke Sync Agent
        if: steps.pre-check.outputs.skip == 'false'
        timeout-minutes: 15
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          REPO: ${{ github.event.client_payload.repo }}
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
          SHORT_SHA: ${{ steps.branch.outputs.short_sha }}
          COMMIT_SHA: ${{ github.event.client_payload.commit_sha }}
        run: |
          echo "================ DISPATCH PAYLOAD ================"
          cat /tmp/sync-payload.json
          echo ""
          echo "===================================================="

          claude --print --dangerously-skip-permissions "
          Read ALL files in agents/sync-agent/ (instructions.md, format.md, style.md, commands.md, skills.md) and follow those instructions exactly.

          ## Dispatch Payload
          Read the dispatch payload from the file: /tmp/sync-payload.json

          ## Source Files
          The source repository has been checked out at: _source/$REPO/
          Read changed files from that directory.

          ## Task
          You are already on branch \`$BRANCH_NAME\` in the NX-KNOWLEDGE-BASE repository.
          Process each file listed in the payload from the \`$REPO\` repository.
          - Generate or update documentation JSON files under \`repos/$REPO/docs/\`
          - Update \`repos/$REPO/meta.json\`
          - Use commit SHA \`$COMMIT_SHA\` when constructing GitHub links (link_to_github)
          - Source repo for GitHub links: \`akeylesspro/$REPO\`

          IMPORTANT:
          - Do NOT create a new branch.
          - Do NOT open a PR.
          - Do NOT run 'git commit' or 'git push'. Only modify files in the working tree.
          Only generate/update the documentation files and meta.json, then stop.
          "

          echo "================ GIT DEBUG AFTER AGENT ================="
          echo "PWD:"
          pwd
          echo ""
          echo "Git status porcelain:"
          git status --porcelain
          echo ""
          echo "Git diff repos:"
          git diff -- repos/ || true
          echo "========================================================="

      - name: Detect changes (working tree OR commits)
        if: steps.pre-check.outputs.skip == 'false'
        id: detect-changes
        run: |
          BASE_SHA="${{ steps.branch.outputs.base_sha }}"
          HEAD_SHA="$(git rev-parse HEAD)"

          echo "BASE_SHA=$BASE_SHA"
          echo "HEAD_SHA=$HEAD_SHA"

          # Case A: agent created commits (despite being told not to)
          if [ "$BASE_SHA" != "$HEAD_SHA" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "change_mode=commits" >> $GITHUB_OUTPUT
            echo "Agent created commits."
            exit 0
          fi

          # Case B: agent modified working tree (expected behavior)
          git add repos/ || true
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "change_mode=none" >> $GITHUB_OUTPUT
            echo "No documentation changes detected."
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "change_mode=working_tree" >> $GITHUB_OUTPUT
            echo "Detected documentation changes in working tree."
          fi

      - name: Commit changes (only if agent did NOT commit)
        if: steps.pre-check.outputs.skip == 'false' && steps.detect-changes.outputs.has_changes == 'true' && steps.detect-changes.outputs.change_mode == 'working_tree'
        run: |
          git commit -m "docs(sync): ${{ github.event.client_payload.repo }} @ ${{ steps.branch.outputs.short_sha }}"

      - name: Push sync branch
        if: steps.pre-check.outputs.skip == 'false' && steps.detect-changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.name }}

      - name: Create Pull Request
        if: steps.pre-check.outputs.skip == 'false' && steps.detect-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILES_LIST=$(cat /tmp/sync-payload.json | jq -r '.files[]' 2>/dev/null || echo "N/A")
          gh pr create \
            --title "docs(sync): ${{ github.event.client_payload.repo }} @ ${{ steps.branch.outputs.short_sha }}" \
            --body "$(cat <<EOF
          ## Sync Summary

          **Repository:** \`${{ github.event.client_payload.repo }}\`
          **Branch:** \`${{ github.event.client_payload.branch }}\`
          **Commit:** [\`${{ steps.branch.outputs.short_sha }}\`](https://github.com/akeylesspro/${{ github.event.client_payload.repo }}/commit/${{ github.event.client_payload.commit_sha }})
          **Timestamp:** \`${{ github.event.client_payload.timestamp }}\`
          **Files processed:** ${{ github.event.client_payload.file_count }}

          ### Changed Source Files
          \`\`\`
          $FILES_LIST
          \`\`\`

          > Generated by the Sync Agent via \`receive-sync.yml\`
          EOF
          )" \
            --base main \
            --head ${{ steps.branch.outputs.name }}

      - name: No changes detected
        if: steps.pre-check.outputs.skip == 'false' && steps.detect-changes.outputs.has_changes == 'false'
        run: |
          echo "::warning::Sync agent ran but produced no documentation changes for ${{ github.event.client_payload.repo }} @ ${{ steps.branch.outputs.short_sha }}."
          echo "This may indicate the changed files have no exported symbols to document."

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Sync pipeline failed for repo=${{ github.event.client_payload.repo }} commit=${{ github.event.client_payload.commit_sha }}"
          echo "## Sync Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ github.event.client_payload.repo }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.event.client_payload.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** \`${{ github.event.client_payload.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Files:** ${{ github.event.client_payload.file_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." >> $GITHUB_STEP_SUMMARY
